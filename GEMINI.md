# Gemini Project Context: Videogrep

This document provides essential context for Gemini to understand and work with the `videogrep` project.

## Project Overview

**Videogrep** is a command-line tool designed to search through dialog in video and audio files and automatically generate "supercuts" (compilations of clips) based on matching search queries. It functions like `grep`, but for time-based media.

### Key Features
- **Regex Search:** Search for phrases or patterns using regular expressions in subtitle tracks or transcriptions.
- **Transcription Support:** Automatically transcribe media using **OpenAI Whisper** (via `pywhispercpp`), **Vosk**, or **Pocketsphinx**.
- **Multiple Search Types:**
  - `sentence`: Clips containing full sentences matching the query.
  - `fragment`: Precise word or phrase matching (requires word-level timestamps).
  - `mash`: Randomly selects instances of specific words to create a "mashup".
- **Export Formats:** Supports `.mp4`, `.mp3`, `.m3u` (playlists), `.mpv.edl` (previews), and `.xml` (Final Cut Pro/Premiere/Resolve timelines).
- **Automation:** Includes `auto_videogrep.py` for a seamless "transcribe then search" workflow.

### Core Technologies
- **Language:** Python 3.10+
- **Media Engine:** [MoviePy 2.x](https://zulko.github.io/moviepy/) (utilizes FFmpeg and NumPy 2.0+).
- **Transcription:** OpenAI Whisper (optimized via `pywhispercpp` for macOS/Windows performance).
- **Dependency Management:** [Poetry](https://python-poetry.org/).
- **Subtitle Parsing:** Custom parsers for `.srt`, `.vtt`, and `.json`.

---

## Project Architecture

- `videogrep/`: The core package.
  - `cli.py`: Entry point for the `videogrep` command.
  - `videogrep.py`: The heart of the logicâ€”handles searching, padding, synchronization, and clip concatenation.
  - `transcribe.py`: Integrates Whisper for generating transcripts.
  - `vtt.py`, `srt.py`, `sphinx.py`: Parsers for various subtitle/transcript formats.
  - `fcpxml.py`: Logic for exporting to Final Cut Pro XML format.
- `auto_videogrep.py`: A wrapper script that simplifies the workflow of transcribing a video and then running a search on it.
- `examples/`: Contains scripts demonstrating advanced usage (silence removal, POS tagging, etc.).
- `tests/`: Comprehensive test suite using `pytest`.

---

## Building and Running

### Setup
Ensure **FFmpeg** is installed and available in your system PATH.

```bash
# Install dependencies using Poetry
poetry install

# Install with extra features (Whisper, Spacy)
poetry install --extras "full"
```

### Running the CLI
```bash
# Basic search
poetry run videogrep --input video.mp4 --search "phrase"

# Transcribe and search (using the automation script)
python auto_videogrep.py video.mp4 "search query" --model medium
```

### Testing
```bash
# Run the test suite
poetry run pytest
```

---

## Development Conventions

- **Subtitles Mapping:** `videogrep` expects subtitle/transcript files to have the *exact same name* as the media file (e.g., `video.mp4` and `video.srt`).
- **Memory Management:** For large supercuts, `create_supercut_in_batches` is used to prevent memory exhaustion and MoviePy crashes by processing clips in groups.
- **Logging:** All user-facing output should be handled through the `logging` module (INFO level for progress, ERROR for issues).
- **Word-Level Timestamps:** The `fragment` search type specifically requires `words` data in the transcript JSON/VTT, which is generated by Whisper and YouTube's cued VTTs.
- **Cross-Platform:** The project is maintained for both macOS (Metal acceleration) and Windows (CUDA/AVX acceleration).

---

## Current Roadmap
- [ ] Implement a **FastAPI** backend for a web application version.
- [ ] Create a **React (Vite)** frontend with TailwindCSS and Framer Motion for a premium GUI experience.
- [ ] Enhance interactive CLI features.
